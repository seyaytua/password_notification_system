name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Clean install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip uninstall -y numpy pandas || echo "No existing numpy/pandas found"
          pip install --no-cache-dir numpy==1.24.4
          pip install --no-cache-dir pandas==2.0.3
          pip install --no-cache-dir -r requirements.txt
          pip install pyinstaller==6.3.0
      
      - name: Verify installation
        run: |
          python -c "import numpy, pandas; print(f'NumPy: {numpy.__version__}'); print(f'Pandas: {pandas.__version__}')"
      
      - name: Clean build directories
        shell: cmd
        run: |
          if exist build rmdir /s /q build
          if exist dist rmdir /s /q dist
      
      - name: Build Windows executable
        run: |
          pyinstaller --clean --noconfirm --onefile --windowed --name PasswordNotificationSystem --exclude-module matplotlib --exclude-module scipy main.py
      
      - name: Test executable creation
        shell: cmd
        run: |
          if exist dist\PasswordNotificationSystem.exe (echo "âœ… EXE created successfully") else (echo "âŒ EXE creation failed" && exit 1)
      
      - name: Create ZIP archive
        run: |
          mkdir release
          move dist\PasswordNotificationSystem.exe release\
          echo "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŠçŸ¥ã‚‰ã›ã‚·ã‚¹ãƒ†ãƒ  v${{ github.ref_name }}" > release\README.txt
          echo "" >> release\README.txt
          echo "ä½¿ã„æ–¹:" >> release\README.txt
          echo "1. PasswordNotificationSystem.exe ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•" >> release\README.txt
          echo "2. å„Stepã‚’é †ç•ªã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >> release\README.txt
          Compress-Archive -Path release\* -DestinationPath PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Executable
          path: PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip
          body: |
            ## ğŸ“¦ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŠçŸ¥ã‚‰ã›ã‚·ã‚¹ãƒ†ãƒ  ${{ github.ref_name }}
            
            ### â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            **Windowsç‰ˆ**: `PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip`
            
            ### ğŸš€ ä½¿ã„æ–¹
            1. ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£å‡
            2. PasswordNotificationSystem.exe ã‚’å®Ÿè¡Œ
            3. Windows Defenderã®è­¦å‘Š: ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€
            
            ### âœ¨ æ©Ÿèƒ½
            - Step 1: ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´
            - Step 2: ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ  
            - Step 3: ãƒ©ã‚¤ã‚»ãƒ³ã‚¹PDFä½œæˆ
            - Step 4: ãƒ•ã‚¡ã‚¤ãƒ«æŒ¯ã‚Šåˆ†ã‘
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
