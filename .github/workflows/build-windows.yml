name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Clean install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip uninstall -y numpy pandas || echo "No existing numpy/pandas found"
          pip install --no-cache-dir numpy==1.24.4
          pip install --no-cache-dir pandas==2.0.3
          pip install --no-cache-dir -r requirements.txt
          pip install pyinstaller==6.3.0
      
      - name: Verify installation
        run: |
          python -c "import numpy, pandas; print(f'NumPy: {numpy.__version__}'); print(f'Pandas: {pandas.__version__}')"
      
      - name: Clean build directories
        shell: cmd
        run: |
          if exist build rmdir /s /q build
          if exist dist rmdir /s /q dist
      
      - name: Build Windows executable
        run: |
          pyinstaller --clean --noconfirm --onefile --windowed --name PasswordNotificationSystem --exclude-module matplotlib --exclude-module scipy main.py
      
      - name: Test executable creation
        shell: cmd
        run: |
          if exist dist\PasswordNotificationSystem.exe (echo "✅ EXE created successfully") else (echo "❌ EXE creation failed" && exit 1)
      
      - name: Create ZIP archive
        run: |
          mkdir release
          move dist\PasswordNotificationSystem.exe release\
          echo "パスワードお知らせシステム v${{ github.ref_name }}" > release\README.txt
          echo "" >> release\README.txt
          echo "使い方:" >> release\README.txt
          echo "1. PasswordNotificationSystem.exe をダブルクリックして起動" >> release\README.txt
          echo "2. 各Stepを順番に実行してください" >> release\README.txt
          Compress-Archive -Path release\* -DestinationPath PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Executable
          path: PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip
          body: |
            ## 📦 パスワードお知らせシステム ${{ github.ref_name }}
            
            ### ⬇️ ダウンロード
            **Windows版**: `PasswordNotificationSystem-Windows-${{ github.ref_name }}.zip`
            
            ### 🚀 使い方
            1. ZIPをダウンロードして解凍
            2. PasswordNotificationSystem.exe を実行
            3. Windows Defenderの警告: 「詳細情報」→「実行」
            
            ### ✨ 機能
            - Step 1: ファイル名変更
            - Step 2: フォルダ作成  
            - Step 3: ライセンスPDF作成
            - Step 4: ファイル振り分け
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
